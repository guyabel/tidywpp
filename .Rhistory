library(fs)
library(tidyverse)
library(purrrlyr)
d <- dir_ls(path = "D:\\ADRI\\project\\data-unpd\\wpp\\data-zip-csv", recurse = TRUE)
d0 <- d %>%
as_tibble() %>%
rename(path = 1) %>%
mutate(path = as.character(path)) %>%
filter(!str_detect(string = path, pattern = "zip$"),
!str_detect(string = path, pattern = "-CSV-data$"))
d1 <- d0 %>%
mutate(wpp = str_extract(string = path, pattern = "\\d{4}"),
file = str_remove(string = path, pattern = "\\.csv"),
file = str_remove(string = file, pattern = paste0("(.)*", "WPP", wpp, "_")),
d = map(.x = path, .f = ~read_csv(file = .x)))
d2 <- d1 %>%
select(-path) %>%
mutate(dd = map(.x = d,
.f = function(x = .x){
x %>%
nest(-Variant)
}))
d2
d2 <- d1 %>%
select(-path) %>%
mutate(dd = map(.x = d,
.f = function(x = .x){
x %>%
nest(-Variant)
})) %>%
select(-d) %>%
unnest(dd)
d2 <- d1 %>%
select(-path) %>%
mutate(dd = map(.x = d,
.f = function(x = .x){
x %>%
nest(-Variant)
})) %>%
select(-d)
d2
d2 <- d1 %>%
select(-path) %>%
mutate(dd = map(.x = d,
.f = function(x = .x){
x %>%
nest(-Variant)
}))
d2$d <- NULL
d2
d2 <- d2 %>%
# select(-d) %>%
unnest(dd)
d2
d2 <- d2 %>%
# select(-d) %>%
# unnest(dd) %>%
mutate(file_group = str_remove(string = file, pattern = "_Medium|_OtherVariants"),
file_group = str_remove(string = file_group, pattern = "_\\d{4}-\\d{4}"))
table(d2$file)
table(d2$file_group)
d2
d2$data[[1]]
d2 <- d2 %>%
mutate(col_name = map(.x = data, .f = ~colnames(.x)),
n_row = map(.x = data, .f = ~nrow(.x)),
n_col = map(.x = data, .f = ~ncol(.x)),
loc = map(.x = data,
.f = function(x = .x){
x %>%
select(starts_with("Loc")) %>%
distinct()
}),
var = map(.x = data,
.f = function(x = .x){
x %>%
select(starts_with("Var")) %>%
distinct()
}),
time = map(.x = data,
.f = function(x = .x){
x %>%
select(Time, MidPeriod) %>%
distinct() %>%
mutate(Time = as.character(Time))
}),
age = map(.x = data,
.f = function(x = .x){
x %>%
select(contains("Age")) %>%
distinct() %>%
mutate_all(as.character)
}),
sex = map(.x = data,
.f = function(x = .x){
x %>%
select(contains("Sex")) %>%
distinct()
}),
var_col = map(.x = data,
.f = function(x = .x){
x %>%
select(-one_of("Location",  "MidPeriod", "AgeGrpStart", "AgeGrpSpan", "Sex")) %>%
select(-one_of("LocID",  "Time", "AgeGrp", "SexID")) %>%
pivot_longer(cols = -starts_with("Var")) %>%
drop_na() %>%
select(-value) %>%
distinct()
})
)
d2
gc()
gc()
d2 <- d2 %>%
mutate(col_name = map(.x = data, .f = ~colnames(.x)),
n_row = map(.x = data, .f = ~nrow(.x)),
n_col = map(.x = data, .f = ~ncol(.x)),
loc = map(.x = data,
.f = function(x = .x){
x %>%
select(starts_with("Loc")) %>%
distinct()
}),
var = map(.x = data,
.f = function(x = .x){
x %>%
select(starts_with("Var")) %>%
distinct()
}),
time = map(.x = data,
.f = function(x = .x){
x %>%
select(Time, MidPeriod) %>%
distinct() %>%
mutate(Time = as.character(Time))
}),
age = map(.x = data,
.f = function(x = .x){
x %>%
select(contains("Age")) %>%
distinct() %>%
mutate_all(as.character)
}),
sex = map(.x = data,
.f = function(x = .x){
x %>%
select(contains("Sex")) %>%
distinct()
}),
# var_col = map(.x = data,
#               .f = function(x = .x){
#                 x %>%
#                   select(-one_of("Location",  "MidPeriod", "AgeGrpStart", "AgeGrpSpan", "Sex")) %>%
#                   select(-one_of("LocID",  "Time", "AgeGrp", "SexID")) %>%
#                   pivot_longer(cols = -starts_with("Var")) %>%
#                   drop_na() %>%
#                   select(-value) %>%
#                   distinct()
#               })
)
d2
d2 <- d2 %>%
mutate(col_name = map(.x = data, .f = ~colnames(.x)),
n_row = map_dbl(.x = data, .f = ~nrow(.x)),
n_col = map_dbl(.x = data, .f = ~ncol(.x)),
loc = map(.x = data,
.f = function(x = .x){
x %>%
select(starts_with("Loc")) %>%
distinct()
}),
var = map(.x = data,
.f = function(x = .x){
x %>%
select(starts_with("Var")) %>%
distinct()
}),
time = map(.x = data,
.f = function(x = .x){
x %>%
select(Time, MidPeriod) %>%
distinct() %>%
mutate(Time = as.character(Time))
}),
age = map(.x = data,
.f = function(x = .x){
x %>%
select(contains("Age")) %>%
distinct() %>%
mutate_all(as.character)
}),
sex = map(.x = data,
.f = function(x = .x){
x %>%
select(contains("Sex")) %>%
distinct()
}),
# var_col = map(.x = data,
#               .f = function(x = .x){
#                 x %>%
#                   select(-one_of("Location",  "MidPeriod", "AgeGrpStart", "AgeGrpSpan", "Sex")) %>%
#                   select(-one_of("LocID",  "Time", "AgeGrp", "SexID")) %>%
#                   pivot_longer(cols = -starts_with("Var")) %>%
#                   drop_na() %>%
#                   select(-value) %>%
#                   distinct()
#               })
)
d2''
d2
d2 %>%
select(wpp, file_group, Variant, col_name) %>%
unnest(col_name)
d2 %>%
select(wpp, file_group, Variant, col_name) %>%
unnest(col_name) %>%
write_csv("./build-data/meta/varibles.csv")
d2 <- NULL
gc()
gc()
library(fs)
library(tidyverse)
library(purrrlyr)
d <- dir_ls(path = "D:\\ADRI\\project\\data-unpd\\wpp\\data-zip-csv", recurse = TRUE)
d0 <- d %>%
as_tibble() %>%
rename(path = 1) %>%
mutate(path = as.character(path)) %>%
filter(!str_detect(string = path, pattern = "zip$"),
!str_detect(string = path, pattern = "-CSV-data$"))
d1 <- d0 %>%
mutate(wpp = str_extract(string = path, pattern = "\\d{4}"),
file = str_remove(string = path, pattern = "\\.csv"),
file = str_remove(string = file, pattern = paste0("(.)*", "WPP", wpp, "_")),
d = map(.x = path, .f = ~read_csv(file = .x)),
d = map(.x = d,
.f = function(x = .x){
x %>%
group_by(Variant, VarID) %>%
nest()
}))
d <- dir_ls(path = "D:\\ADRI\\project\\data-unpd\\wpp\\data-zip-csv", recurse = TRUE)
d0 <- d %>%
as_tibble() %>%
rename(path = 1) %>%
mutate(path = as.character(path)) %>%
filter(!str_detect(string = path, pattern = "zip$"),
!str_detect(string = path, pattern = "-CSV-data$"))
d1 <- d0 %>%
slice(1:20) %>%
mutate(wpp = str_extract(string = path, pattern = "\\d{4}"),
file = str_remove(string = path, pattern = "\\.csv"),
file = str_remove(string = file, pattern = paste0("(.)*", "WPP", wpp, "_")),
d = map(.x = path, .f = ~read_csv(file = .x)),
d = map(.x = d,
.f = function(x = .x){
x %>%
group_by(Variant, VarID) %>%
nest()
}))
d1
d1 %>% unnest(d)
d1 <- d1 %>% unnest(d)
d1
d1 <- d1 %>%
mutate(file_group = str_remove(string = file, pattern = "_Medium|_OtherVariants"),
file_group = str_remove(string = file_group, pattern = "_\\d{4}-\\d{4}"))
d1
d1 <- d0 %>%
slice(90:101) %>%
mutate(wpp = str_extract(string = path, pattern = "\\d{4}"),
file = str_remove(string = path, pattern = "\\.csv"),
file = str_remove(string = file, pattern = paste0("(.)*", "WPP", wpp, "_")),
d = map(.x = path, .f = ~read_csv(file = .x)),
d = map(.x = d,
.f = function(x = .x){
x %>%
group_by(Variant, VarID) %>%
nest()
}))
d1 <- d1 %>%
unnest(d)
d1 <- d1 %>%
mutate(file_group = str_remove(string = file, pattern = "_Medium|_OtherVariants"),
file_group = str_remove(string = file_group, pattern = "_\\d{4}-\\d{4}"))
d1
tail(d1)
d1 %>%
filter(file_group == "period")
table(d1$file_group)
d1 %>%
filter(file_group == "Period_Indicators")
d1 %>%
filter(file_group == "Period_Indicators") %>%
slice(14) %>%
pull(data)
x = d1 %>%
filter(file_group == "Period_Indicators") %>%
slice(14) %>%
pull(data) %>%
.[[1]]
x
summary(x$NRR)
x = d1 %>%
filter(file_group == "Period_Indicators") %>%
slice(14) %>%
pull(data) %>%
.[[1]] %>%
janitor::remove_empty(which = "cols")
x
library(janitor)
d1 <- d1 %>%
mutate(data = map(.x = data, .f = remove_empty_cols(dat = .x)))
d1 <- d1 %>%
mutate(data = map(.x = data, .f = remove_empty(dat = .x, which = "cols")))
d1
d1 <- d1 %>%
mutate(data = map(.x = data, .f = ~remove_empty(dat = .x, which = "cols")))
d1
d1 %>%
filter(file_group == "Period_Indicators") %>%
slice(14) %>%
pull(data) %>%
.[[1]]
